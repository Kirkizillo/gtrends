name: Google Trends Monitor

on:
  # 5 grupos × 2 ejecuciones/día = 10 runs diarios
  # Separación de ~2h25min entre runs para evitar solapamientos
  # Cada grupo tarda ~40 min (3 términos × 4 regiones × 200s)
  schedule:
    - cron: '0 0,12 * * *'    # group_1: WW, IN, US, BR
    - cron: '25 2,14 * * *'   # group_2: ID, MX, PH, GB
    - cron: '50 4,16 * * *'   # group_3: AU, VN, DE, RU
    - cron: '15 7,19 * * *'   # group_4: TH, FR, IT, CN
    - cron: '40 9,21 * * *'   # group_5: JP, TR, RO, NG

  # Permitir ejecución manual desde GitHub
  workflow_dispatch:
    inputs:
      group:
        description: 'Country group to run (leave empty for all)'
        required: false
        default: ''
        type: choice
        options:
          - ''
          - 'group_1'
          - 'group_2'
          - 'group_3'
          - 'group_4'
          - 'group_5'

# Permisos necesarios para crear issues
permissions:
  contents: read
  issues: write

jobs:
  # Determinar qué grupo ejecutar basado en la hora
  determine-group:
    runs-on: ubuntu-latest
    outputs:
      group: ${{ steps.set-group.outputs.group }}
    steps:
      - name: Determine group from schedule
        id: set-group
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "group=${{ github.event.inputs.group }}" >> $GITHUB_OUTPUT
          else
            # Rangos de hora para tolerar retrasos de GitHub Actions
            # 10 slots de ~2h25min distribuidos en 24h
            # Crons: g1=0,12h  g2=2:25,14:25h  g3=4:50,16:50h  g4=7:15,19:15h  g5=9:40,21:40h
            HOUR=$(date -u +%H)
            MIN=$(date -u +%M)
            # Convertir a minutos desde medianoche para comparaciones más precisas
            TOTAL_MIN=$(( 10#$HOUR * 60 + 10#$MIN ))

            if [ "$TOTAL_MIN" -ge 0 ] && [ "$TOTAL_MIN" -lt 145 ]; then
              echo "group=group_1" >> $GITHUB_OUTPUT     # 00:00–02:24 UTC
            elif [ "$TOTAL_MIN" -ge 145 ] && [ "$TOTAL_MIN" -lt 290 ]; then
              echo "group=group_2" >> $GITHUB_OUTPUT     # 02:25–04:49 UTC
            elif [ "$TOTAL_MIN" -ge 290 ] && [ "$TOTAL_MIN" -lt 435 ]; then
              echo "group=group_3" >> $GITHUB_OUTPUT     # 04:50–07:14 UTC
            elif [ "$TOTAL_MIN" -ge 435 ] && [ "$TOTAL_MIN" -lt 580 ]; then
              echo "group=group_4" >> $GITHUB_OUTPUT     # 07:15–09:39 UTC
            elif [ "$TOTAL_MIN" -ge 580 ] && [ "$TOTAL_MIN" -lt 720 ]; then
              echo "group=group_5" >> $GITHUB_OUTPUT     # 09:40–11:59 UTC
            elif [ "$TOTAL_MIN" -ge 720 ] && [ "$TOTAL_MIN" -lt 865 ]; then
              echo "group=group_1" >> $GITHUB_OUTPUT     # 12:00–14:24 UTC
            elif [ "$TOTAL_MIN" -ge 865 ] && [ "$TOTAL_MIN" -lt 1010 ]; then
              echo "group=group_2" >> $GITHUB_OUTPUT     # 14:25–16:49 UTC
            elif [ "$TOTAL_MIN" -ge 1010 ] && [ "$TOTAL_MIN" -lt 1155 ]; then
              echo "group=group_3" >> $GITHUB_OUTPUT     # 16:50–19:14 UTC
            elif [ "$TOTAL_MIN" -ge 1155 ] && [ "$TOTAL_MIN" -lt 1300 ]; then
              echo "group=group_4" >> $GITHUB_OUTPUT     # 19:15–21:39 UTC
            else
              echo "group=group_5" >> $GITHUB_OUTPUT     # 21:40–23:59 UTC
            fi
          fi

  scrape-and-export:
    needs: determine-group
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create credentials file
        env:
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
        run: |
          echo "$GOOGLE_CREDENTIALS" > credentials.json

      - name: Create .env file
        env:
          GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
          PROXIES: ${{ secrets.PROXIES }}
        run: |
          echo "GOOGLE_SHEET_ID=$GOOGLE_SHEET_ID" > .env
          echo "GOOGLE_CREDENTIALS_PATH=credentials.json" >> .env
          echo "PROXIES=$PROXIES" >> .env

      - name: Run Google Trends Monitor
        run: |
          GROUP="${{ needs.determine-group.outputs.group }}"
          if [ -n "$GROUP" ]; then
            python main.py --group $GROUP
          else
            python main.py
          fi
        timeout-minutes: 90

      - name: Upload logs as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ github.run_number }}-${{ needs.determine-group.outputs.group || 'all' }}
          path: logs/
          retention-days: 7

      - name: Notify on failure (Slack)
        if: failure() && env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"Google Trends Monitor failed! Group: ${{ needs.determine-group.outputs.group || 'all' }} - Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}" \
            $SLACK_WEBHOOK_URL

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = `Scraping failed - ${new Date().toISOString().split('T')[0]}`;
            const body = `## Scraping Failed\n\n- **Group:** ${{ needs.determine-group.outputs.group || 'all' }}\n- **Run:** [View logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n- **Time:** ${new Date().toISOString()}\n\nPlease check the logs for more details.`;

            // Check if similar issue exists in last 24h
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'scraping-failure',
              per_page: 5
            });

            const recentIssue = issues.data.find(i => {
              const created = new Date(i.created_at);
              const now = new Date();
              return (now - created) < 24 * 60 * 60 * 1000;
            });

            if (!recentIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['scraping-failure', 'automated']
              });
            }

      - name: Close resolved issues on success
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'scraping-failure'
            });

            for (const issue of issues.data) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed',
                state_reason: 'completed'
              });
              console.log(`Closed issue #${issue.number}: ${issue.title}`);
            }
